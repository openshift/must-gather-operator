apiVersion: batch/v1
kind: Job
spec:
  template:
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - preference:
              matchExpressions:
              - key: node-role.kubernetes.io/infra
                operator: Exists
            weight: 1
      tolerations:
        - effect: NoSchedule
          key: node-role.kubernetes.io/infra
          operator: Exists
      restartPolicy: OnFailure
      shareProcessNamespace: true
      containers:
      - command:
        - /bin/bash
        - -c
        image: quay.io/openshift/origin-must-gather:MUST_GATHER_IMAGE_DONT_CHANGE
        name: gather
        volumeMounts:
        - mountPath: /must-gather
          name: must-gather-output
      - command:
        - /bin/bash
        - -c
        - |
          count=0
          until [ $count -gt 4 ]
          do
            while `pgrep -a gather > /dev/null`
            do
              echo "waiting for gathers to complete ..." 
              sleep 120
              count=0
            done
            echo "no gather is running ($count / 4)"
            ((count++))
            sleep 30
          done
          /usr/local/bin/upload
        image: THIS_STRING_WILL_BE_REPLACED_BUT_DONT_CHANGE_IT
        name: upload
        volumeMounts:
        - mountPath: /must-gather
          name: must-gather-output
        - mountPath: /must-gather-upload
          name: must-gather-upload
        env:
        - name: username
          valueFrom:
            secretKeyRef:
              key: username
        - name: password
          valueFrom:
            secretKeyRef:
              key: password
        - name: caseid
        - name: must_gather_output
          value: /must-gather
        - name: must_gather_upload
          value: /must-gather-upload
        - name: internal_user
      volumes:
      - emptyDir: {}
        name: must-gather-output
      - emptyDir: {}
        name: must-gather-upload

